name: Fork Repositories via hub-mirror-action

on:
  workflow_dispatch:            # 手动触发
  schedule:
    - cron: '0 0 * * 0'        # 每周日 00:00 UTC 自动运行（可自行修改）

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install --quiet --upgrade pip

      - name: Generate repository matrix
        id: set-matrix
        env:
          OFFSET: ${{ env.OFFSET }}   # 可在 workflow 中自行设定，默认 0
          LIMIT:  ${{ env.LIMIT }}    # 默认 256
        run: |
          MATRIX=$(python scripts/generate_repo_matrix.py)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
  
  mirror-repos:
    needs: generate-matrix
    runs-on: ubuntu-latest
    # 为 GITHUB_TOKEN 分配必要的权限（如果使用 secrets.GITHUB_TOKEN）
    permissions:
      contents: write
      packages: write
    strategy:
      matrix:
        include: ${{ fromJSON(needs.generate-matrix.outputs.matrix) }}
    steps:
      - name: Mirror repository
        uses: Yikun/hub-mirror-action@master
        with:
          src: ${{ matrix.src }}
          dst: ${{ matrix.dst }}
          # Token 配置（二选一）：
          # 方案 A: 使用手动配置的 Personal Access Token（推荐，权限更全）
          dst_token: ${{ secrets.FORK_TOKEN }}
          # 方案 B: 使用 GitHub 自动提供的 Token（无需配置 Secret，但权限可能受限）
          # dst_token: ${{ secrets.GITHUB_TOKEN }}
          # 明确指定使用 HTTPS 克隆方式（避免 SSH 权限问题）
          clone_style: https
          # 指定账户类型（org = 组织，user = 用户）
          account_type: org
          static_list: ${{ matrix.static_list }}
          force_update: ${{ matrix.force_update }}
          # 如需使用 SSH 方式，需要配置：
          # dst_key: ${{ secrets.GITHUB_PRIVATE_KEY }}
          # clone_style: ssh